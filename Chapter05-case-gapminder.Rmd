---
title: "Gapminder Case Study"
subtitle: "Descriptive Analytics and Data Visualization"
author: "Yichen Qin (qinyn@ucmail.uc.edu), University of Cincinnati"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    code_folding: "show"
    toc: true
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
---


# Visualization Case Study {-}

The following R packages are needed for running the examples in this chapter.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggthemes)
library(grid)
library(gridExtra)
#library(Lahman)
#library(MASS) # conflict with dplyr package for select(), use dplyr::select
library(RColorBrewer)
library(ggridges)
library(ggrepel)
library(kableExtra)
```



# Case Study: Gapminder Data Set

This case study is originally developed in @Irizarry2019.

We have made some modifications to the case, but the majority of the analysis follows their book.
We will analyze the gapminder data set^[https://www.gapminder.org/data/] which is about the statistics of different countries measured over the years.

## Motivation

The data set is created by Hans Rosling^[https://en.wikipedia.org/wiki/Hans_Rosling], a professor of international health and a pioneer in data visualization.
Using this data set and the visualization, he wants to educate the public about the common misunderstanding of the world and different countries.
For this initiative, he has created the Gapminder Foundation^[http://www.gapminder.org/] which uses data to show how actual trends in health and economics contradict the narratives that emanate from sensationalist media coverage of catastrophes, tragedies, and other unfortunate events. 
Gapminder identifies systematic misconceptions about important global trends and proportions and uses reliable data to develop easy to understand teaching materials to rid people of their misconceptions.
Its mission is to fight devastating ignorance with a fact-based worldview everyone can understand.

Journalists and lobbyists tell dramatic stories. That’s their job. They tell stories about extraordinary events and unusual people. The piles of dramatic stories pile up in peoples' minds into an over-dramatic worldview and strong negative stress feelings: "The world is getting worse!", "It’s we vs. them!”, “Other people are strange!", "The population just keeps growing!" and "Nobody cares!"
Hans Rosling conveyed actual data-based trends in a dramatic way of his own, using effective data visualization. This section is based on two talks that exemplify this approach to education: New Insights on Poverty^[https://www.ted.com/talks/hans_rosling_reveals_new_insights_on_poverty?language=en] and The Best Stats You've Ever Seen^[https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen]. 

On the [Gapminder website](http://www.gapminder.org/), there are a list of questions about the wealth health and economics.
You can go through these questions and test your knowledge and understanding.
In his TED talk^[https://www.youtube.com/watch?v=hVimVzgtD6w], Hans Rosling tested the audience with questions on the world health such as the child mortality across different countries. 
For example, for each pair of countries below, which country do you think had the highest child mortality rates in 2015?

1. Sri Lanka or Turkey
2. Poland or South Korea
3. Malaysia or Russia
4. Pakistan or Vietnam
5. Thailand or South Africa

When answering these questions without data, the non-European countries are typically picked as having higher child mortality rates: Sri Lanka over Turkey, South Korea over Poland, and Malaysia over Russia. It is also common to assume that countries considered to be part of the developing world: Pakistan, Vietnam, Thailand, and South Africa, have similarly high mortality rates. 

To answer these questions, we use data, we can use __dplyr__. For example, for the first comparison we see that:

```{r, message=FALSE}
gapminder = read.csv("data/gapminder.csv",header = TRUE)
gapminder %>% 
  filter(year == 2015 & country %in% c("Sri Lanka","Turkey")) %>% 
  select(country, infant_mortality)
```

Turkey has the higher infant mortality rate. We can use this code on all comparisons and find the following:

```{r, echo = FALSE, message=FALSE, warning=FALSE}
comp_table <- tibble(comparison = rep(1:5, each = 2),
           country = c("Sri Lanka", "Turkey", "Poland", "South Korea", "Malaysia", "Russia", "Pakistan","Vietnam","Thailand","South Africa"))
tmp <- gapminder %>% 
  filter(year == 2015) %>% 
  select(country, infant_mortality) %>% 
  mutate(country = as.character(country)) ##to match characters to characters
  
tab <- inner_join(comp_table, tmp, by = "country") %>% select(-comparison)
  
tmp <- bind_cols(slice(tab,seq(1,9,2)), slice(tab,seq(2,10,2)))
names(tmp) <- c("country", "infant mortality", "country", "infant mortality")
if(knitr::is_html_output()){
  knitr::kable(tmp, "html") %>%
    kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE)
} else{
  knitr::kable(tmp, "latex", booktabs = TRUE) %>%
    kableExtra::kable_styling(font_size = 8)
}
```

We see that the European countries on this list have higher child mortality rates: Poland has a higher rate than South Korea, and Russia has a higher rate than Malaysia. We also see that Pakistan has a much higher rate than Vietnam, and South Africa has a much higher rate than Thailand. It turns out that when Hans Rosling gave this quiz to educated groups of people, the average score was less than 2.5 out of 5, worse than what they would have obtained had they guessed randomly. This implies that more than ignorant, we are misinformed. In this chapter we see how data visualization helps inform us.


Specifically, in this section, we use data to attempt to answer the following two questions:

1. Is it a fair characterization of today's world to say it is divided into western rich nations and the developing world in Africa, Asia, and Latin America? 
2. Has income inequality across countries worsened during the last 40 years? 

## Data Import

We start by importing the data to R from the csv file.

```{r}
gapminder = read.csv("data/gapminder.csv",header = TRUE)
dim(gapminder)
head(gapminder)
```

As we can see there are 9 variables and 10545 observations.
Each row represents one particular country in a particular year.
These 9 variables include:

- `country`: name of the country. There are 185 countries in total.
- `year`: the year of observation. It ranges from 1960 to 2016.
- `infant_mortality`: the infant mortality of the country in that year.
- `life_expectancy`: the life expectancy of the country in that year.
- `fertility`: the fertility rate of the country in that year.
- `population`: the population rate of the country in that year.
- `gdp`: the GDP of the country in that year.
- `continent`: the continent the country belongs to. Values include Europe, Africa, Americas, Asia, and Oceania.
- `region`: the region the country belongs to the following values

```{r}
unique(gapminder$region)
unique(gapminder$year)
```

## Missing Data

We check to see if there are any missing data and how the missing values distribute in the data.

```{r}
colSums(is.na(gapminder))
```

As we can see, there are a lot of missing observations for the infant mortality rate, fertility rate, population, and gdp.

```{r, out.width="100%"}
missing_by_year = gapminder %>% 
  group_by(year) %>%
  summarize(num_missing_infant_mortality = sum(is.na(infant_mortality)),
            num_missing_fertility = sum(is.na(fertility)),
            num_missing_population = sum(is.na(population)),
            num_missing_gdp = sum(is.na(gdp)))
missing_year_long = pivot_longer(missing_by_year, cols = 2:5, names_to = "variable", values_to = "missing_num")
ggplot(missing_year_long)+
  geom_bar(aes(year,missing_num),width=0.5, stat = "identity")+ # geom_col()
  facet_wrap(~variable)+
  scale_x_continuous(breaks = seq(1960,2010,10))
```

On the other hand, we can look at the missing values for each country.

```{r}
missing_by_coun = gapminder %>% 
  group_by(country) %>%
  summarize(num_missing_infant_mortality = sum(is.na(infant_mortality)),
            num_missing_fertility = sum(is.na(fertility)),
            num_missing_population = sum(is.na(population)),
            num_missing_gdp = sum(is.na(gdp)))
missing_by_coun %>% 
  arrange(desc(num_missing_infant_mortality)) %>%
  select(country,num_missing_infant_mortality) %>%
  head(10)
missing_by_coun %>% 
  arrange(desc(num_missing_fertility)) %>%
  select(country,num_missing_fertility) %>%
  head(10)
missing_by_coun %>% 
  arrange(desc(num_missing_population)) %>%
  select(country,num_missing_population) %>%
  head(10)
missing_by_coun %>% 
  arrange(desc(num_missing_gdp)) %>%
  select(country,num_missing_gdp) %>%
  head(10)
```

## Divided World

Now we begin to analyze the data set.
There is a common understanding about the world that is the world is divided into two groups: the developed countries which are associate with long life spans and small families, versus the developing countries (Africa, Asia, and Latin America) characterized by short life spans and large families.
Is this true?
To verify this, we propose our first question: 

> Is the world divided in terms of life expectancy and fertility rate (average number of children per woman)?

To answer this question, we use scatterplot of life expectancy versus fertility rate.
We start by looking at data from about 50 years ago, when perhaps this view was first cemented in our minds.

```{r fertility-versus-life-expectancy-1962-with-color, fig.width=4, fig.height=3}
library(RColorBrewer)
gapminder %>%
  filter(year == 1962) %>% # data wrangling
  ggplot(aes(fertility, life_expectancy, color = continent)) + # data visualization
  geom_point() +
  scale_color_brewer(palette = "Paired")
```

As we can see, most countries fall into two distinct categories: 
1. Life expectancy around 70 years and 3 or fewer children per family.
2. Life expectancy lower than 65 years and more than 5 children per family. 
Therefore, it seems this understanding does not have some support from data and is somewhat true 50 years ago. 
However, is it still true today?
In addition, is the situation different than 50 years ago?
To answer this question, we need to regenerate a new figure for 2012 and compare with the previous one.

```{r fertility-versus-life-expectancy-facet, warning=FALSE, fig.width=6, fig.height=3}
gapminder %>%
  filter(year %in% c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_wrap(~year) +
  scale_color_brewer(palette = "Paired")
```

This figure shows the totality of the situation.
If we want to focus on different continent, we can further break it down the comparison.
As we can see, the most improvement takes place in Africa, Americas, and Asia.

```{r, warning=FALSE, fig.width=10, fig.height=6}
gapminder %>%
  filter(year %in% c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_grid(year~continent) +
  scale_color_brewer(palette = "Paired") +
  theme(legend.position = "top")
```

This plot clearly shows that the majority of countries have moved from the _developing world_ cluster to the _western world_ one. 
In conclusion, the belief that the world is divided into two groups are no longer support nowadays.
This is particularly true for Asia.

The figure focus on the overall improvement of the entire world or each continent.
What is we want to focus on each country? We can plot the trajectory of each country.

```{r, out.width="100%",fig.height=4}
gapminder %>%
  filter(year %in% c(1962, 2012)) %>%
  group_by(country) %>%
  summarise(start_fert = fertility[year==1962],
            end_fert = fertility[year==2012],
            start_life = life_expectancy[year==1962],
            end_life = life_expectancy[year==2012],
            continent = continent) %>%
  ggplot() +
  geom_segment(aes(x=start_fert,xend=end_fert,
                   y=start_life,yend=end_life,
                   color=continent,
                   group=country)) +
  facet_wrap(~continent) +
  scale_color_brewer(palette = "Paired")
```

As we can see, Asian and Americas countries collectively improved significantly.
Part of African countries improved significantly in both life expectancy and fertility, but the others have only moderate improvements and these improvement are mostly life expectancy.
Most of the European countries have mild improvements.

We are looking at the span of 50 years, it make sense to look at the data most closely and visualize how the changes took place through the years.
We can add 1970, 1980, 1990, and 2000. If we do this, we will not want all the plots on the same row, the default behavior of `facet_grid`, since they will become too thin to show the data. Instead, we will want to use multiple rows and columns. The function `facet_wrap` permits us to do this by automatically wrapping the series of plots so that each display has viewable dimensions:


```{r fertility-versus-life-expectancy-five-years, out.width="100%", fig.height=3}
gapminder %>% 
  filter(year %in% c(1962, 1980, 1990, 2000, 2012)) %>%
  ggplot( aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_wrap(~year, ncol=5) +
  scale_color_brewer(palette = "Paired") +
  theme(legend.position = "top")
```

```{r, out.width="100%",fig.height=4}
gapminder %>% 
  filter(year %in% seq(1962, 2012, 1)) %>%
  ggplot() +
  geom_path(aes(fertility, life_expectancy, 
                color=continent, group = country)) +
  #geom_text_repel(aes(fertility, life_expectancy, label=year)) +
  facet_wrap(~continent) +
  scale_color_brewer(palette = "Paired")
```
This plot clearly shows how most Asian countries have improved at a much faster rate than European ones.
Meanwhile, an interesting pattern is that most countries improve the life expectancy first and then reduce the fertility rate.
This makes sense because the increase of life expectancy implies the improvement of health care quality.
Once the health care condition is improved, the family does not need give birth to many children.


The default choice of the range of the axes is important. 
When not using `facet`, this range is determined by the data shown in the plot. 
When using `facet`, this range is determined by the data shown in all plots and therefore kept fixed across plots. 
This makes comparisons across plots much easier. For example, in the above plot, we can see that life expectancy has increased and the fertility has decreased across most countries. We see this because the cloud of points moves. 
This is not the case if we adjust the scales:
In the plot above, we have to pay special attention to the range to notice that the plot on the right has a larger life expectancy. 

```{r facet-without-fixed-scales, warning=FALSE, eval=FALSE}
filter(gapminder, year%in%c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, col = continent)) +
  geom_point() +
  facet_wrap(. ~ year, scales = "free")
```


We can repeat the same analysis using another pair of variables.

```{r, fig.width=6, fig.height=3}
gapminder %>%
  filter(year %in% c(1962, 2011)) %>% # data wrangling
  mutate(income = gdp/population) %>%
  ggplot(aes(income, life_expectancy, color = continent)) + # data visualization
  scale_x_log10()+
  geom_point() +
  facet_wrap(~year) +
  scale_color_brewer(palette = "Paired")
```

## Income Inequality

Another commonly held belief is that the wealth inequality has became more serious over the years with the rich getting richer and poor getting poorer.
We now shift our attention to the second question related to the commonly held notion that wealth distribution across the world has become worse during the last decades. 

> Did the income inequality in the world become worse or better?

When general audiences are asked if poor countries have become poorer and rich countries become richer, the majority answers yes. 
By using stratification, histograms, smooth densities, and boxplots, we will be able to understand if this is in fact the case. 
First we learn how transformations can sometimes help provide more informative summaries and plots.

We use the GDP per capita as a measure of individual wealth and create this variable in the data set.
Note that income is adjusted for inflation and represent current US dollars, so it is comparable across the years. 
In addition, this variable represents the average income of that country. 
There are certainly variation in income within that country, which is not what we are studing right now because we do not have assess to this data.

```{r}
gapminder <- gapminder %>%  
  mutate(dollars_per_day = gdp/population/365,
         gdp_per_capita = gdp/population)
```

Here is a histogram of GDP per capita from 1970.

```{r dollars-per-day-distribution, fig.width=4,fig.height=3}
past_year <- 1970
# gapminder %>% 
#   filter(year == past_year & !is.na(gdp_per_capita)) %>%
#   ggplot(aes(dollars_per_day)) + 
#   geom_histogram(binwidth = 1, color = "black")
gapminder %>% 
  filter(year == past_year & !is.na(gdp_per_capita)) %>%
  ggplot(aes(gdp_per_capita)) + 
  geom_histogram(binwidth = 1000)
```

Because of the skeness of the data, the visualization mainly displays the countries with gdp per capita above \$4000.
So we are unclear about the distribution of the gdp per capita for the rest of the countries, even though they are the majority in the data. 

To address this issue, we consider the log transformation which convert the scale into a multiplicative order.

In addition to log base 10 transformation. 
Other common choices are base $\mathrm{e}$ (the natural log) and base 2.

In general, the natural log should be avoided just because $\mathrm{e}^2, \mathrm{e}^3, \dots$ are harder and less intuitive to calculate.
In comparison, log base 2 and log base 10 are better choices, because $2^2, 2^3, 2^4, \dots$ or $10^2, 10^3, \dots$ are easy to compute in our heads.

In the dollars per day example, we used base 2 instead of base 10 because the resulting range is easier to interpret. The range of the values being plotted is `r gapminder %>% filter(year==past_year) %>% select(gdp_per_capita) %>% range(na.rm=TRUE)`. 

In base 10, this turns into a range that includes very few integers: just 0 and 1. 
With base two, our range includes -2, -1, 0, 1, 2, 3, 4, and 5. It is easier to compute $2^x$ and $10^x$ when $x$ is an integer and between -10 and 10, so we prefer to have smaller integers in the scale. Another consequence of a limited range is that choosing the binwidth is more challenging. With log base 2, we know that a binwidth of 1 will translate to a bin with range $x$ to $2x$.

For an example in which base 2 makes more sense, consider the daily gdp per capita which equals to gdp per capita divided by 365. 


There are two ways to transform the data for visualization. 
- Transform the values before plotting them, i.e., `aes(x=log10(gdp_per_capita))`. I1n this case, the axis ticks display the transformed values such as 1, 2, 3, ...
- Use transformed scales in the axes, i.e., `+scale_x_continuous(trans="log10")`. In this case, the axis ticks display the original values such as 10, 100, 1000, ...
Both approaches are useful and have different strengths. 
Usually, the latter gives a better visualization of the data.

There are other transformations available through the `trans` argument.

- The square root (`sqrt`) transformation is useful when considering counts. 
- The logistic transformation (`logit`) is useful when plotting proportions between 0 and 1. 
- The `reverse` transformation is useful when we want smaller values to be on the right or on top.


If we use the log transformation with base of 10, then we can easily show $100 (extremely poor), \$500 (very poor), \$1000 (poor), \$5000 (middle), \$10000 (well off), \$50000 (rich), \$100000 (very rich).
This transformation provides a close-up of the mid to lower income countries.
Here is the distribution if we apply a log base 10 transform:

```{r dollars-per-day-distribution-log, fig.width=6, fig.height=3}
g1=gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(x=gdp_per_capita)) + 
  geom_histogram(binwidth = .18)+
  scale_x_continuous(trans="log10")
g2=gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(gdp_per_capita)) + 
  geom_histogram(binwidth =0.7) +
  scale_x_continuous(trans="log2")
grid.arrange(g1,g2,ncol=2)
```

We see multiple bumps in the histogram. 
This is often referred to as [multimodal distribution](https://en.wikipedia.org/wiki/Multimodal_distribution). 
The locations where the density reaches local maximum are called local modes.

The histogram above suggests that the 1970 country income distribution has two modes: one at about 1000 dollars and another at about 10000 dollars. 
This _bimodality_ is consistent with a dichotomous world made up of countries with average incomes less than $5000 and countries above that. 
**However, which countries consist of these two groups?**

In addition to the histogram, we can visualize the same data using density plot.



### Comparison among Regions

A histogram shows that the 1970 income has a multimodal distirbution which implies that the there are multiple clusters of countries with similar incomes and the clusters are separated from each other. 
However, we still do not know what are these clusters.
Do these clusters represent the developed world and devleoping world?
We will learn about clustering analysis in the later chapters.
For now, we can manually divide the countries according to their geographical locations, such as continent and region.


```{r, fig.width=4, fig.height=3}
gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(gdp_per_capita, fill=continent)) + 
  geom_histogram(binwidth =.18) +
  scale_x_continuous(trans="log10") +
  scale_fill_brewer(palette = "Paired")
```

Let's start by quickly examining the data by region. We reorder the regions by the median value and use a log scale.


```{r dollars-per-day-points, fig.width=10}
gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(gdp_per_capita, reorder(continent,gdp_per_capita), fill=continent)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(height=0.1, shape = 4) +
  scale_x_continuous(trans = "log10") +
  annotation_logticks(sides = "b") +
  scale_fill_brewer(palette = "Paired") +
  theme(legend.position = "top")
```

```{r, out.width="100%", out.height="100%"}
gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  mutate(region = reorder(region, gdp_per_capita, FUN = median)) %>%
  ggplot(aes(gdp_per_capita, region, 
             fill=continent, 
             label=country)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_point(shape = 4) +
  geom_text_repel(color="blue", size=2)+
  scale_x_continuous(trans = "log10") +
  annotation_logticks(sides = "b") +
  scale_fill_brewer(palette = "Paired") +
  scale_color_brewer(palette = "Paired") +
  theme(legend.position = "top")
```

```{r}
gapminder %>% 
  filter(year == past_year, 
         !is.na(gdp),
         region == "Western Asia") %>%
  select(country, region, gdp_per_capita) 
```

We can already see that there is indeed a "west versus the rest" dichotomy: we see two clear groups, with the rich group composed of North America, Northern and Western Europe, New Zealand and Australia. We define groups based on this observation.
We turn this `group` variable into a factor to control the order of the levels.


```{r}
gapminder <- gapminder %>% 
  mutate(group = case_when(
    region %in% c("Northern Europe",
                  "Northern America",
                  "Australia and New Zealand",
                  "Western Europe",
                  "Southern Europe")  ~ "Developed",
    country %in% c("Japan", "Israel", "Hong Kong, China", "French Polynesia", "") ~ "Developed",
    region %in% c("Eastern Asia", 
                  "South-Eastern Asia",
                  "Southern Asia",
                  "Western Asia") ~ "Asia",
    region %in% c("Caribbean", 
                  "Central America", "South America") ~ "Latin America",
    continent == "Africa" ~ "Africa",
    TRUE ~ "Others"))
gapminder <- gapminder %>% 
  mutate(group = factor(group, levels = c("Others","Latin America", "Asia", "Africa", "Developed")))
```


The exploratory data analysis above has revealed two characteristics about average income distribution in 1970. Using a histogram, we found a bimodal distribution with the modes relating to poor and rich countries. We now want to compare the distribution across these five groups to confirm the "west versus the rest" dichotomy. The number of points in each category is large enough that a summary plot may be useful. We could generate five histograms or five density plots, but it may be more practical to have all the visual summaries in one plot. We therefore start by stacking boxplots next to each other. Note that we add the layer `theme(axis.text.x = element_text(angle = 90, hjust = 1))` to turn the group labels vertical, since they do not fit if we show them horizontally, and remove the axis label to make space.
Boxplots have the limitation that by summarizing the data into five numbers, we might miss important characteristics of the data. One way to avoid this is by showing the data.


```{r, fig.width=10,fig.height=3}
g1=gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(gdp_per_capita, reorder(group,gdp_per_capita), fill=group)) +
  geom_boxplot() +
  geom_jitter(height = 0.2, shape=4) +
  scale_x_continuous(trans = "log10") +
  scale_fill_brewer(palette = "Dark2")
g2=gapminder %>% 
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(gdp_per_capita, fill=group)) + 
  geom_histogram(binwidth = .18) +
  scale_x_continuous(trans="log10") +
  scale_fill_brewer(palette = "Dark2")
grid.arrange(g1,g2,ncol=2)
```

The jitter scatter plot shows the location of each individual point.
This does not always reveal important characteristics of the distribution.
when the number of data points is so large that there is over-plotting, showing the data can be counterproductive. 

The sistogram shows the interval each data point belongs to.
This is less information than the scatter plot, but still sometimes can be overwhelming, and masks the true pattern in the data.

On the other hand, the boxplot further summarizes the data by providing a five-number summary, but this sometimes can be a over simplification of the data. 
For example, the boxplot **does not permit us to discover bimodal distributions**.

Apparenly, we need something in between, which is the density plot.
We can show stacked smooth densities or histograms. 
We refer to these as _ridge plots_. Because we are used to visualizing densities with values in the x-axis, we stack them vertically. 
Also, because more space is needed in this approach, it is convenient to overlay them.
A useful `geom_density_ridges` parameter is `scale`, which lets you determine the amount of overlap, with `scale = 1` meaning no overlap and larger values resulting in more overlap. 

Similar to the box plot above, we can add data to the ridge plot.
The height of the points is jittered and should not be interpreted in any way. 
Alternatively, we could the rug representation of the data.  



```{r ridge-plot, message=FALSE}
library(ggridges)
gapminder %>% 
  filter(year == past_year & !is.na(gdp_per_capita)) %>%
  ggplot(aes(gdp_per_capita, group, color=group)) + 
  geom_density_ridges(scale=1, jittered_points = TRUE) +
  geom_density_ridges(scale=1, jittered_points = TRUE, 
                      position = position_points_jitter(height = 0),
                      point_shape = '|', point_size = 3, 
                      point_alpha = 1, alpha = 0.7) +
  scale_x_continuous(trans = "log10") + 
  scale_fill_brewer(palette = "Dark2")
```
```{r}
gapminder %>% 
  filter(year == past_year & !is.na(gdp_per_capita)) %>%
  ggplot(aes(gdp_per_capita, fill=group)) + 
  geom_density(alpha = 0.5, position="stack", bw = 0.2) +
  scale_x_continuous(trans = "log10", limit = c(30, 150000)) +
  scale_fill_brewer(palette = "Dark2")
```

### Comparison between Developed and Developing Countries

**Now versus then** for income inequality

Visualization shows that there are two clusters in income. 
But does this dichotomy persist? Let's use `facet_grid` see how the distributions have changed. To start, we will focus on two groups: the west and the rest. We make four histograms.

Before we interpret the findings of this plot, we notice that there are more countries represented in the 2010 histograms than in 1970: the total counts are larger. One reason for this is that several countries were founded after 1970. For example, the Soviet Union divided into several countries during the 1990s. Another reason is that data was available for more countries in 2010.  

We remake the plots using only countries with data available for both years. In the data wrangling part of this book, we will learn __tidyverse__ tools that permit us to  write efficient code for this, but here we can use simple code using the `intersect` function:

```{r}
past_year <- 1970
present_year <- 2010
years <- c(past_year, present_year)
country_list_1 <- gapminder %>% 
  filter(year == past_year & !is.na(gdp_per_capita)) %>% 
  pull(country)
country_list_2 <- gapminder %>% 
  filter(year == present_year & !is.na(gdp_per_capita)) %>% 
  pull(country)
country_list <- intersect(country_list_1, country_list_2)
```


These `r length(country_list)` account for 
`r round(gapminder %>% filter(year==present_year) %>% summarize(perc=sum(population[country%in%country_list], na.rm=TRUE)/sum(population, na.rm=TRUE)) %>% pull(perc)*100 )`% of the world population, so this subset should be representative.

Let's remake the plot, but only for this subset by simply adding ` country %in% country_list` to the `filter` function:

```{r income-histogram-west-v-devel}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(west = ifelse(group == "Developed", "Developed", "Developing")) %>%
  ggplot(aes(gdp_per_capita)) +
  geom_histogram(binwidth = 0.18, color = "black") +
  scale_x_continuous(trans = "log10") + 
  facet_grid(year ~ west)
```

We now see that the rich countries have become a bit richer, but percentage-wise, the poor countries appear to have improved more. In particular, we see that the proportion of _developing_ countries earning more than $16 a day increased substantially. 

To see which specific regions improved the most, we can remake the boxplots we made above, but now adding the year 2010 and then using facet to compare the two years.


```{r  income-histogram-by-region, out.width="100%"}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  ggplot(aes(group, gdp_per_capita)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(trans = "log10") +
  xlab("") +
  facet_grid(. ~ year)
```

Here, we pause to introduce another powerful __ggplot2__ feature. Because we want to compare each region before and after, it would be convenient to have the `r past_year` boxplot next to the `r present_year` boxplot for each region. In general, comparisons are easier when data are plotted next to each other.

So instead of faceting, we keep the data from each year together and ask  to color (or fill) them depending on the year. Note that groups are automatically separated by year and each pair of boxplots drawn next to each other. Because year is a number, we turn it into a factor since __ggplot2__ automatically assigns a color to each category of a factor. Note that we have to convert the year columns from numeric to factor. 

```{r, fig.height=8,fig.width=8}
g1 = gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(year = factor(year)) %>%
  ggplot(aes(group, gdp_per_capita, fill = year)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
g2 = gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(year = factor(year)) %>%
  ggplot(aes(continent, gdp_per_capita, fill = year)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
g3 = gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(year = factor(year)) %>%
  ggplot(aes(region, gdp_per_capita, fill = year)) +
  geom_boxplot() +
  scale_y_continuous(trans = "log10") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
plots1=list(g1,g2,g3)
lay1 = rbind(c(1, 2), c(3, 3)) 
grid.arrange(grobs = plots1,
             layout_matrix = lay1)  
```

Finally, we point out that if what we are most interested in is comparing before and after values, it might make more sense to plot the percentage increases. We are still not ready to learn to code this, but here is what the plot would look like:

```{r, warning=FALSE, fig.height=8, fig.width=8}
g1 = gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(year = ifelse(year == past_year, "past", "present")) %>%
  select(country, group, year, gdp_per_capita) %>%
  spread(year, gdp_per_capita)  %>%
  mutate(percent_increase = (present-past)/past*100) %>%
  mutate(group = reorder(group, percent_increase, FUN = median)) %>%
  ggplot(aes(group, percent_increase, fill=group)) +
    geom_boxplot() + 
    geom_point(show.legend = FALSE, shape=4) +
    scale_y_continuous(trans = "log10") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ylab(paste("Percent increase:", past_year, "to", present_year)) +
    scale_fill_brewer(palette = "Dark2")
g2 = gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(year = ifelse(year == past_year, "past", "present")) %>%
  select(country, region, year, gdp_per_capita, continent) %>%
  spread(year, gdp_per_capita)  %>%
  mutate(percent_increase = (present-past)/past*100) %>%
  mutate(continent = reorder(continent, 
                             percent_increase, FUN = median)) %>%
  ggplot(aes(continent, percent_increase, fill = continent)) +
    geom_boxplot() + 
    geom_jitter(width=0.1,shape=4, show.legend = FALSE) +
    scale_y_continuous(trans = "log10") +
    scale_fill_brewer(palette = "Paired") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("") + 
    ylab(paste("Percent increase:", past_year, "to", present_year)) 
g3 = gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(year = ifelse(year == past_year, "past", "present")) %>%
  select(country, region, year, gdp_per_capita, continent) %>%
  spread(year, gdp_per_capita)  %>%
  mutate(percent_increase = (present-past)/past*100) %>%
  mutate(region = reorder(region, 
                          percent_increase, FUN = median)) %>%
  ggplot(aes(region, percent_increase, fill = continent)) +
    geom_boxplot() + 
    geom_jitter(width=0.1,shape=4, show.legend = FALSE) +
    scale_y_continuous(trans = "log10") +
    scale_fill_brewer(palette = "Paired") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    xlab("") + 
    ylab(paste("Percent increase:", past_year, "to", present_year)) 
plots1=list(g1,g2,g3)
lay1 = rbind(c(1, 2), c(3, 3)) 
grid.arrange(grobs = plots1,
             layout_matrix = lay1) 
```


The previous data exploration suggested that the income gap between rich and poor countries has narrowed considerably during the last 40 years. 
We used a series of histograms and boxplots to see this. We suggest a succinct way to convey this message with just one plot. 

**Summary**

Let's start by noting that density plots for income distribution in `r past_year` and `r present_year` deliver the message that the gap is closing:

```{r income-smooth-density-by-year, out.width="100%", fig.height=3}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  ggplot(aes(gdp_per_capita)) +
    geom_density(fill = "grey") + 
    scale_x_continuous(trans = "log10", limit = c(30, 150000), 
                       breaks=c(100,1000,10000,100000),
                       labels=c("100","1000","10000","100000")) + 
    facet_grid(. ~ year)
```

In the `r past_year` plot, we see two clear modes: poor and rich countries. In `r present_year`, it appears that some of the poor countries have shifted towards the right, closing the gap. 

The next message we need to convey is that the reason for this change in distribution is that several poor countries became richer, rather than some rich countries becoming poorer. To do this, we can assign a color to the groups we identified during data exploration. 

However, we first need to learn how to make these smooth densities in a way that preserves information on the number of countries in each group. To understand why we need this, note the discrepancy in the size of each group:

```{r, echo=FALSE}
tmp <- gapminder %>% 
  filter(year == past_year & country %in% country_list) %>%
  mutate(group = ifelse(group == "Developed", "Developed", "Developing")) %>% 
  group_by(group) %>% 
  summarize(n=n()) %>%
  spread(group, n)
if(knitr::is_html_output()){
  knitr::kable(tmp, "html") %>%
    kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE)
} else{
  knitr::kable(tmp, "latex", booktabs = TRUE) %>%
    kableExtra::kable_styling(font_size = 8)
}
```

But when we overlay two densities, the default is to have the area represented by each distribution add up to 1, regardless of the size of each group. This makes it appear as if there are the same number of countries in each group. To change this, we will need to learn to access computed variables with `geom_density` function.

To have the areas of these densities be proportional to the size of the groups, we can simply multiply the y-axis values by the size of the group. From the `geom_density` help file, we see that the functions compute a variable called `count` that does exactly this. We want this variable to be on the y-axis rather than the density.

In __ggplot2__, we access these variables by surrounding the name with two dots. We will therefore use the following mapping. 
If we want the densities to be smoother, we use the `bw` argument so that the same bandwidth is used in each density. We selected 0.2 after trying out several values.

```{r income-smooth-density-counts}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  mutate(group = ifelse(group == "Developed", "Developed", "Developing")) %>%
  ggplot(aes(x = gdp_per_capita, y = ..count.., fill = group)) +
    scale_x_continuous(trans = "log10", limit = c(30,100000)) + 
    geom_density(alpha = 0.2, bw = 0.2) + 
    facet_grid(year ~ .)
```

This plot now shows what is happening very clearly. The developing world distribution is changing. A third mode appears consisting of the countries that most narrowed the gap. 

To visualize if any of the groups defined above are driving this we can quickly make a ridge plot:

```{r ridge-plot-income-five-regions, warning=FALSE, message=FALSE}
gapminder %>% 
  filter(year %in% years & !is.na(gdp_per_capita)) %>%
  ggplot(aes(gdp_per_capita, group)) + 
    geom_density_ridges(adjust = 1.5) +
    scale_x_continuous(trans = "log10", limit = c(30,100000)) + 
    facet_grid(. ~ year)
```

Another way to achieve this is by stacking the densities on top of each other:

```{r income-smooth-density-counts-by-region-and-year}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  group_by(year) %>%
  mutate(weight = population/sum(population)) %>%
  ungroup() %>%
  ggplot(aes(gdp_per_capita, fill = group)) +
    geom_density(alpha = 0.2, bw = 0.2, position = "stack") + 
    scale_x_continuous(trans = "log10", limit = c(30, 150000)) + 
    facet_grid(year ~ .) 
```

Here we can clearly see how the distributions for East Asia, Latin America, and others shift markedly to the right. While Sub-Saharan Africa remains stagnant. 

Notice that we order the levels of the group so that the West's density is plotted first, then Sub-Saharan Africa. Having the two extremes plotted first allows us to see the remaining bimodality better.


**Weighted densities**

As a final point, we note that these distributions weigh every country the same. So if most of the population is improving, but living in a very large country, such as China, we might not appreciate this. We can actually weight the smooth densities using the `weight` mapping argument. The plot then looks like this:

```{r income-smooth-density-counts-by-region-year-weighted, warning=FALSE}
gapminder %>% 
  filter(year %in% years & country %in% country_list) %>%
  group_by(year) %>%
  mutate(weight = population/sum(population)) %>%
  ungroup() %>%
  ggplot(aes(gdp_per_capita, fill = group, weight = weight)) +
    geom_density(alpha = 0.2, bw = 0.2, position = "stack") + 
    scale_x_continuous(trans = "log10", limit = c(30, 150000)) + 
    facet_grid(year ~ .)
```

This particular figure shows very clearly how the income distribution gap is closing with most of the poor remaining in Sub-Saharan Africa.

# References {-}
