---
title: "Ch4P2 Visualization Basics Part II"
subtitle: "Descriptive Analytics and Data Visualization"
author: "Yichen Qin (qinyn@ucmail.uc.edu), University of Cincinnati"
date: "`r Sys.Date()`"
output: 
  html_document:
    number_sections: true
    code_folding: "show"
    toc: true
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
---

In this chapter, we continue to discuss the visualization basics.
The following R packages are needed for running the examples in this chapter.

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(grid)
library(gridExtra)
library(RColorBrewer)
```

# Barplot

So far we have focused on visualizing continuous variables through the example of scatter plots.
In addition to continuous variables, discrete variables are also common in data analysis.
In this section, we will focus on visualizing discrete variables.
In this case, a barplot is the most frequently used tool.

For example, we could use the barplot to show the frequency/distribution of different categories and the composition of the discrete variable.
In the college data set, suppose we are interested in the number of university in different regions in US, such as northeast, midwest, west, and south. 
Then we could use the barplot to visualize this information.
The code below consists two parts.
The first part transforms the original data to the counts of universities in each region using `group_by()` and `summarize()` functions.
This is essentially the data wrangling step.
The second part take the count data and plot it in the barplot using the geometry function `geom_col()`, which is the data visualization step.
Note that it is always better to have meaningful x or y axis in the barplot.
For example, we could sort all the bars according to the frequencies.

```{r,fig.width=6, fig.height=3}
college = read.csv("data/college.csv", header = TRUE)
region_freq = college %>% 
  group_by(region) %>% 
  summarise(count=n())
region_freq
g1 = ggplot(region_freq) + 
  geom_col(aes(x = region, y = count))
g2 = college %>% 
  group_by(region) %>% 
  summarize(count=n()) %>%
  ggplot() + 
  geom_col(aes(x = reorder(region, count), 
               y = count)) +
  xlab("Region")
grid.arrange(g1, g2, ncol=2)
```

The code above first counts the number of universities in each region, and then plot their frequencies.
Alternatively, we could manually calculate the frequencies ourselves and directly plot them.
We will need to either set `stat="identity"` in `geom_bar()`, or use `geom_col()`.
Note that ordering the axis is slightly different in `geom_col()` than in `geom_bar()`.

Meanwhile, in addition to `geom_col()`, `geom_bar()` is another option for generating the barplot.
To directly plot the counts in `region_freq`, we could use `geom_bar(aes(xxx, yyy), stat="identity")`.
In addition, `geom_bar()` can combines the data wrangling step with the data visualization step.
To achieve this, we remove `stat="identity"` and directly plug the college data set into `ggplot()`.
For details, please refer to the following code.
Note that the code below all produce the same results.

```{r, fig.width=10, fig.height=3, eval=FALSE}
g1 = ggplot(region_freq) + 
  geom_col(aes(y=region, x = count))
g2 = ggplot(region_freq) + 
  geom_bar(aes(y=region, x = count), stat="identity")
g3 = ggplot(college) + 
  geom_bar(aes(y=region)) + ylab("region")
grid.arrange(g1,g2,g3, ncol=3)
```





The barplot not only can visualize the distribution of one discrete variable, but also the relationship between two or more discrete variables through its variations.
For example, the argument `position` in `geom_bar()` function can adjust the position to show different graphical properties which includes "identity", "dodge", "fill",and "stack".

- "identity": No adjustment. So it generates the traditional barplot.
- "dodge": It splits each bar into multiple pieces and generates side-by-side bars.
- "fill": It fills different colors within each bar and use bar lengths to represent proportions.
- "stack": It adds different colors to one bar and generate stacked bars.

For the college data set example, suppose we want to visualize the association between the region of the university `region` and the funding type of the university, we can use the following barplots.

```{r, fig.width=9, fig.height=3}
g1=ggplot(data=college) +
  geom_bar(aes(x=fct_relevel(region, "South", "Midwest", "Northeast", "West"), fill = control), 
           width=0.75) + 
  scale_x_discrete(name = "Region") +
  scale_fill_discrete(name = "")+
  theme(legend.position = "top")
g2=ggplot(data=college) +
  geom_bar(aes(x=region, fill = control), 
           position="fill", 
           width = 0.75) + 
  scale_x_discrete(name = "Region") +
  scale_fill_discrete("")+
  scale_y_continuous(name="precent", labels = scales::percent)+
  theme(legend.position = "top")
g3=ggplot(data=college) +
  geom_bar(aes(x=fct_relevel(region, "South", "Midwest", "Northeast", "West"), fill = control), 
           position="dodge", 
           width=0.75) +
  scale_x_discrete(name = "Region") +
  scale_fill_discrete("") +
  theme(legend.position = "top")
grid.arrange(g1,g2,g3,ncol=3)
```

If we want to avoid using dodge or stacked barplot, we could use facet visualization and plot barplots side by side.

```{r, fig.width=6, fig.height=3}
ggplot(data=college) +
  geom_bar(aes(x=fct_relevel(region, "South", "Midwest", "Northeast", "West"),
               fill = control), 
           width=0.75) +
  scale_x_discrete(name = "Region") +
  scale_y_continuous(limits = c(0, 250)) +
  facet_wrap(~control)
```

When visualizing the amount across different categories, barplot may not be the most suitable tool. 
Take a look at the following example.
We plot the average SAT score in each state in US using a barplot.
Note that we have sort the bars according to the SAT scores.
The SAT score are mostly between 800 and 1400 (You get 400 by just putting your name down).
When we take the average across all universities in each state,
the variation in the SAT score for each state becomes even less.
Therefore, we mostly see many long bars of similar lengths.
The visualization is accurate, but not informative.
We can emphasize on the difference of SAT score by changing the range of y-axis, which is the middle figure.
However, the length of the bar is not proportional to SAT which violates one of the most important principal in data visualization.
We will discuss this principal in details in the following chapter.
For example, it seems that the SAT of North Carolina (NC) is about twice the SAT of West Virginia (WV) since the bar of the former is twice as long as the bar of latter.
In this case, we can alternatively use dot plot, which is just scatter plot, but with one axis being discrete data.
The dot only indicates the location of the data point.

```{r, fig.width=10, fig.height=6}
state_sat_df = college %>% 
  group_by(state) %>%
  summarize(state_sat = mean(sat_avg))
g1 = state_sat_df %>%
  ggplot() + 
  geom_col(aes(y=fct_reorder(state, state_sat), x = state_sat), width = 0.7) + 
  scale_y_discrete(name = "State") +
  xlab("Average SAT")
g2 = state_sat_df %>%
  ggplot() + 
  geom_col(aes(y=fct_reorder(state, state_sat), x = state_sat), width = 0.7) + 
  scale_y_discrete(name = "State") +
  coord_cartesian(xlim = c(950,1200) ) +
  scale_x_continuous(expand = c(0,0)) +
  xlab("Average SAT") +
  theme(axis.ticks.y = element_blank())
g3 = state_sat_df %>%
  ggplot() + 
  geom_point(aes(y=fct_reorder(state, state_sat), x = state_sat), size = 2) + 
  scale_y_discrete(name = "State") +
  coord_cartesian(xlim = c(950,1200) ) +
  scale_x_continuous(expand = c(0,0)) +
  xlab("Average SAT") +
  geom_vline(xintercept = mean(college$sat_avg), 
             color = "blue",
             linetype = "dotted")+
  theme(axis.ticks.y = element_blank(),
        panel.grid.major.y = element_line(color = "grey",
                                          linetype = "dashed"))
grid.arrange(g1,g2,g3,ncol=3)
```

There are many variations of the barplot, for example, **population pyramid**.
We use Saudi Arabia's population data to generate the population pyramid as follows.
As we can see, there are much more working age men in Saudi Arabia than women.
This is because there are many immigrants coming to Saudi Arabia for work.

```{r, message=FALSE, warning=FALSE}
saudi = read_csv("data/saudi_arabia.csv")
saudi
saudi %>%
  select(GROUP, `Male Population`, `Female Population`) %>%
  rename(age = GROUP,
         male = `Male Population`,
         female = `Female Population`) %>%
  filter(age != c("TOTAL", "100+")) %>%
  mutate_at(c("age"), as.numeric) %>%
  mutate(age_group = cut(age, breaks = seq(0, 100, 5), right = FALSE)) %>%
  pivot_longer(cols = c("male", "female"), 
               names_to = "gender", 
               values_to = "pop") %>%
  ggplot() +
  geom_col(aes(y = age_group, 
               x = ifelse(gender == "male", pop, -pop),
               fill = gender)) +
  scale_x_continuous(labels = abs) +
  xlab("Population") +
  ylab("Age")
```

The barplot can sometimes be confused with the histogram.
However, they have different purposes and should be applied to different scenarios.
The barplot visualizes the distribution of the discrete data, whereas the histogram visualizes the distribution of the continuous data.
In the college data set, suppose we are interested in the distribution of the continuous variable SAT, then we could use histogram.
Compared the histogram with the barplot at the beginning of this section, we can see that the bars are separated and the order of the bars can be customized since it is the discrete data.
On the other hand, the bars in the histogram are adjacent to each other because each bar represents the frequency of the observations falling into the consecutive intervals.

```{r}
ggplot(data = college, aes(x = sat_avg)) +
       geom_histogram(bins=15)
```

# Pie/Donut Chart

We briefly discuss the pie chart, which is used to visualize the composition of a discrete variable.
There are two forms for pie charts, the filled circle or colored ring.
The pie chart uses the angel or the length of the curve to represent the proportion of each category or an unique value.
Since these angels or curves are often in different orientations, the comparison across different categories are often difficult.
This is also why we do not recommend pie chart.
Instead, we should use the barplot which is more efficient.

Let us take a look at the example.
Suppose we would like to compare on the number of universities in the five states in the midwest area, including OH, MI, IN, IL, and WI.
We generate the pie chart, the ring chart, and the barplot for comparison.
As we can see, other than OH which has the most of the universities, it is hard to compare the rest of the states as they angels and ring segments are almost the same.
When looking the barplot, it is apparent that WI has the lowest number, while IL is higher than IN and IN is higher than MI.
This insight cannot be easily obtained in the pie chart and donute chart, which is why we should avoid using them.
There are some remedies for these charts, such as adding the percentage numbers next to the pie. 
But the visualization is meant to be self-explanatory, efficient and faithfully, adding the text is conflicting to these goals.

```{r, fig.width=10, fig.height=4}
g1 = ggplot(filter(college, state %in% c("OH", "MI", "IN", "IL", "WI")), 
            aes(x = 1, fill = state)) + 
  geom_bar() + 
  scale_fill_discrete("State")+
  coord_polar(theta = "y") + 
  theme(panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "top")
g2=ggplot(filter(college, state %in% c("OH", "MI", "IN", "IL", "WI")), 
          aes(x = 1, fill = state)) + 
  geom_bar(width = 0.8) +
  scale_fill_discrete("State")+
  coord_polar(theta = "y") + 
  scale_x_continuous(limits=c(0,1.5)) + # Add a continuous x scale from 0.5 to 1.5
  theme(panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "top")
g3=ggplot(filter(college, state %in% c("OH", "MI", "IN", "IL", "WI")), 
          aes(x = state, fill=state)) + 
  scale_fill_discrete("State")+
  geom_bar() + 
  theme(legend.position = "top")
grid.arrange(g1,g2,g3,ncol=3)
```





# Layout and Dashboard

To enhance the visualization, we can display multiple figures side by side or in a grid for better comparison.
In order to set up the layout, we use the R packages `grid` and `gridExtra`.

The `grid` package provides a low-level graphics system to access the graphics facilities in R. 
The `gridExtra` package provides a number of user-level functions to work with `grid` package and to arrange multiple figures on a page.
More specifically, we use `grid.arrange()` functions to set up the layout. 
Here is an example.

```{r}
g1 = ggplot(college, aes(sat_avg, tuition)) +
  geom_point(size=0.1)
g2 = ggplot(college, aes(faculty_salary_avg, tuition))+
  geom_point(size=0.1)
g3 = ggplot(college, aes(loan_default_rate, tuition))+
  geom_point(size=0.1)
g4 = ggplot(college, aes(undergrads, tuition))+
  geom_point(size=0.1)
g5 = ggplot(college, aes(admission_rate, tuition))+
  geom_point(size=0.1)
g6 = ggplot(college, aes(median_debt, tuition))+
  geom_point(size=0.1)
library(grid)
library(gridExtra)
plots<-list(g1,g2,g3,g4,g5,g6)#put 6 plots in one list
vp <- viewport(width =0.6, height =1) #create a viewpoint whose width is 0.6 and height is 1 
grid.arrange(grobs = plots, ncol = 2,vp=vp)
```

We can display different types of visualization together too. 
We draw histogram, stack density plot, and boxplot.
Use more complex layout with the customized width and height of each panel, we use the following code.

```{r}
p1 = ggplot(college, aes(x=tuition)) + geom_histogram() +
  labs(title="Histogram of tuition")
p2 = ggplot(college, aes(x=tuition, y=..density.., fill=control)) + 
  geom_density(position="stack")+
  labs(title="PDF of tuition",x="Tuition")
p3 = ggplot(college, aes(y=tuition, x=control,fill=control))+
  geom_boxplot(outlier.size=.3)+
  labs(title="Boxplot of tuition")
lay1 = rbind(c(1, 1),
            c(2, 3)) #matrix of layout
library(knitr)
knitr::kable(lay1)
plots1=list(p1,p2,p3)
grid.arrange(grobs = plots1,
             layout_matrix = lay1, # matrix of layout is lay1
             widths = c(2, 1),heights = c(0.5,1), 
             # widths 2:1, heights 1:2 
             # try delete this row and see what happens
             top="Distribution of tuition")
```

To adjust the margins of the plot, we specify the arguments in the theme layer.

```{r}
ggplot(college,aes(x=sat_avg, y=tuition))+
  geom_point()+ 
  theme(plot.margin = unit(c(3,3,3,3), "cm")) # the 4 margins of the plot are 2 cm
```

Finally, to save the plot, we use the `ggsave` and `arrangeGrob` functions.

```{r,eval=FALSE}
m<-arrangeGrob(grobs = plots1, layout_matrix = lay1,
               widths = c(2, 1),  heights = c(1, 0.5),
               top="Distribution of Tuition")
ggsave(file="my_fig.png", m, width = 25, height = 20)
```

# Exercises and Solutions

1. 

2.

3. 
